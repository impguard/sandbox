#!/usr/bin/env bash

# shellcheck disable=SC2034

export DOCKER_CONTEXT DOCKER_FILE DOCKER_IMAGE DOCKER_NAME COMPOSE_FILE

DOCKER_CONTEXT="$(dirname "${BASH_SOURCE[0]}")"
DOCKER_FILE="$DOCKER_CONTEXT/Dockerfile"
DOCKER_IMAGE='haskell:fork'
DOCKER_NAME='haskell'

COMPOSE_FILE="$DOCKER_CONTEXT/docker-compose.yml"


bake_task init "Initializes the environment"
function init
{
  docker pull haskell:8.2.1
}


bake_task compose "Wrapper around docker compose"
function compose
{
  docker-compose -f "$COMPOSE_FILE" "$@"
}


bake_task repl "Start a haskell repl"
function repl ()
{
  compose run haskell ghci "$@"
}

bake_task shell "Shell into the haskell environment"
function shell ()
{
  compose run haskell /bin/bash
}

bake_task compile "Compiles a provided haskell source file"
function compile ()
{
  local filename output

  if [ "$#" -lt 1 ]; then
    bake_echo_red "usage: bake compile filename [output]"
    exit 1
  fi

  filename=$1
  output=${2:-compiled.out}

  compose run haskell ghc --make -o "$output" "$filename"
}


bake_task clean "Cleans up generated files and the docker environment"
function clean ()
{
  rm -f ./*.hi ./*.o ./*.out
  compose stop
  bake_echo_green 'Removed generated output and stopped haskell container'
}
